name: Build and deploy Docker image to GHCR

# Reusable workflow per build e push Docker su GitHub Container Registry (ghcr.io)
# - Accetta name e version come input, oppure li estrae da package.json
# - Le versioni sono IMMUTABILI (non sovrascrive se giÃ  esistono)
# - Solo 'latest' e i tag branch vengono sovrascritti

on:
  workflow_call:
    inputs:
      name:
        description: 'Package/image name (default: from package.json or repository name)'
        required: false
        type: string
        default: ''
      version:
        description: 'Version tag (default: from package.json)'
        required: false
        type: string
        default: ''
      folder:
        description: 'Working directory'
        required: false
        type: string
        default: './'
      dockerfile:
        description: 'Path to Dockerfile'
        required: false
        type: string
        default: 'Dockerfile'
      platforms:
        description: 'Target platforms for Docker build'
        required: false
        type: string
        default: 'linux/amd64'
      additional_build_args:
        description: 'Additional build arguments (multiline KEY=value)'
        required: false
        type: string
        default: ''
      image_name:
        description: 'Custom full image name for registry (default: github.repository)'
        required: false
        type: string
        default: ''

    outputs:
      version:
        description: 'Version used for tagging'
        value: ${{ jobs.build-and-push.outputs.version }}
      version_exists:
        description: 'Whether the version tag already existed'
        value: ${{ jobs.build-and-push.outputs.version_exists }}
      tags:
        description: 'Docker image tags that were pushed'
        value: ${{ jobs.build-and-push.outputs.tags }}
      digest:
        description: 'Docker image digest'
        value: ${{ jobs.build-and-push.outputs.digest }}

env:
  REGISTRY: ghcr.io

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    outputs:
      version: ${{ steps.resolve.outputs.version }}
      version_exists: ${{ steps.check-version.outputs.exists }}
      tags: ${{ steps.tags.outputs.tags }}
      digest: ${{ steps.build-push.outputs.digest }}

    defaults:
      run:
        working-directory: ${{ inputs.folder }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract package.json metadata
        id: package
        run: |
          if [ -f "package.json" ]; then
            echo "name=$(node -p "require('./package.json').name || '${{ github.event.repository.name }}'")" >> $GITHUB_OUTPUT
            echo "version=$(node -p "require('./package.json').version || '0.0.0'")" >> $GITHUB_OUTPUT
            echo "description=$(node -p "require('./package.json').description || ''")" >> $GITHUB_OUTPUT
          else
            echo "name=${{ github.event.repository.name }}" >> $GITHUB_OUTPUT
            echo "version=0.0.0" >> $GITHUB_OUTPUT
            echo "description=" >> $GITHUB_OUTPUT
          fi

      - name: Resolve name and version
        id: resolve
        run: |
          # Use input if provided, otherwise fallback to package.json
          if [ -n "${{ inputs.name }}" ]; then
            echo "name=${{ inputs.name }}" >> $GITHUB_OUTPUT
          else
            echo "name=${{ steps.package.outputs.name }}" >> $GITHUB_OUTPUT
          fi
          
          if [ -n "${{ inputs.version }}" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ steps.package.outputs.version }}" >> $GITHUB_OUTPUT
          fi
          
          echo "description=${{ steps.package.outputs.description }}" >> $GITHUB_OUTPUT

      - name: Determine image name
        id: image-name
        run: |
          if [ -n "${{ inputs.image_name }}" ]; then
            echo "name=${{ inputs.image_name }}" >> $GITHUB_OUTPUT
            echo "full=${{ env.REGISTRY }}/${{ inputs.image_name }}" >> $GITHUB_OUTPUT
          else
            echo "name=${{ github.repository }}" >> $GITHUB_OUTPUT
            echo "full=${{ env.REGISTRY }}/${{ github.repository }}" >> $GITHUB_OUTPUT
          fi

      - name: Log in to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if version tag already exists
        id: check-version
        if: github.event_name != 'pull_request'
        run: |
          VERSION="${{ steps.resolve.outputs.version }}"
          IMAGE="${{ steps.image-name.outputs.full }}"
          
          echo "Checking if $IMAGE:$VERSION exists..."
          
          # Try to pull the manifest (without downloading the image)
          if docker manifest inspect "$IMAGE:$VERSION" > /dev/null 2>&1; then
            echo "âš ï¸ Version $VERSION already exists - will be skipped (immutable)"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Version $VERSION does not exist - will be pushed"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up QEMU
        if: contains(inputs.platforms, 'arm')
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build dynamic tags
        id: tags
        run: |
          IMAGE="${{ steps.image-name.outputs.full }}"
          VERSION="${{ steps.resolve.outputs.version }}"
          VERSION_EXISTS="${{ steps.check-version.outputs.exists }}"
          SHA="${{ github.sha }}"
          BRANCH="${{ github.ref_name }}"
          
          # Start with mutable tags (always pushed)
          TAGS="$IMAGE:$BRANCH"
          TAGS="$TAGS,$IMAGE:sha-${SHA:0:7}"
          
          # Add 'latest' only for default branch
          if [ "${{ github.ref }}" = "refs/heads/${{ github.event.repository.default_branch }}" ]; then
            TAGS="$TAGS,$IMAGE:latest"
          fi
          
          # Add version tag ONLY if it doesn't exist (immutable)
          if [ "$VERSION_EXISTS" != "true" ] && [ "$VERSION" != "0.0.0" ]; then
            TAGS="$TAGS,$IMAGE:$VERSION"
            echo "ðŸ“¦ Version $VERSION will be tagged"
          else
            echo "â­ï¸ Version $VERSION skipped (already exists or invalid)"
          fi
          
          echo "tags=$TAGS" >> $GITHUB_OUTPUT
          echo "Tags to push: $TAGS"

      - name: Extract metadata for labels
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.image-name.outputs.full }}
          tags: |
            type=raw,value=placeholder
          labels: |
            org.opencontainers.image.title=${{ steps.resolve.outputs.name }}
            org.opencontainers.image.description=${{ steps.resolve.outputs.description }}
            org.opencontainers.image.version=${{ steps.resolve.outputs.version }}
            org.opencontainers.image.vendor=Responsa

      - name: Build and push Docker image
        id: build-push
        uses: docker/build-push-action@v5
        with:
          context: ${{ inputs.folder }}
          file: ${{ inputs.folder }}/${{ inputs.dockerfile }}
          platforms: ${{ inputs.platforms }}
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.tags.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ steps.resolve.outputs.version }}
            ${{ inputs.additional_build_args }}

      - name: Create summary
        if: github.event_name != 'pull_request'
        run: |
          echo "## ðŸ³ Docker Image Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **Package:** ${{ steps.resolve.outputs.name }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”– **Version:** ${{ steps.resolve.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check-version.outputs.exists }}" = "true" ]; then
            echo "âš ï¸ **Note:** Version tag already existed (immutable) - only latest/branch tags updated" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ·ï¸ Tags pushed" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.tags.outputs.tags }}" | tr ',' '\n' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Pull Command" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ steps.image-name.outputs.full }}:latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
